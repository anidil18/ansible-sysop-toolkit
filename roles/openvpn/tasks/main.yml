- name: install common packages
  apt: name={{ item }} state=installed
  with_items:
    - python-pip
  tags: install_packages

- name: Upgrade pip
  command: pip install --upgrade pip
  tags: install_packages

- name: Docker-PY
  pip:
    name: "{{ item }}"
  with_items:
  - setuptools
#  - six
  - docker-py
  tags: install_packages

#- name: "Create a docker OpenVPN volume"
#  docker_volume:
#    name: openvpn
#  tags: create_volume

- name: create OpenVPN volume
  command: docker volume create --name openvpn
#  when: openvpn_exists|faileda
  tags: create_volume

- name: Install OpenVPN docker container
  docker:
    name: openvpn
    image: kylemanna/openvpn:latest
    state: present
    pull: always
    volumes:
    - /openvpn
    ports:
    - "1194:1194/udp"
  tags: pull_image

- name: Setup OpenVPN step1
  command: docker run -v openvpn:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u udp://vpn.litiushkin.ru
  tags: setup_openvpn

#- name: Setup OpenVPN step2
#  command: docker run -v openvpn:/etc/openvpn --rm  kylemanna/openvpn ovpn_initpki nopass
#  tags: setup_openvpn

#- name: Testing if target exists
#  local_action: stat path='/var/lib/docker/volumes/openvpn'
#  sudo: no
#  register: p
#  tags: tast_existing_config_dir

#- name: Halt if directory does not exist
#  fail:
#    msg: "Target directory does not exist."
#  when: p.stat.isdir is not defined or not p.stat.isdir
#  tags: test_existing_config_dir

- name: Copy over the openvpn configuration
  synchronize:
    src: '/tmp/openvpn'
    dest: '/var/lib/docker/volumes/openvpn'
#    owner: 'root'
#    group: 'root'
    recursive: yes
    links: yes
    perms: yes
    copy_links: yes
    delete: yes
#  with_flattened:
#    - docker_openvpn_users_list
#    - docker_openvpn_users_group_list
#    - docker_openvpn_users_host_list
#  when: item is defined and item != ""
  tags: restore_backup_configuration

#- name: Create link to the OpenVPN configuration for auto startup if not running in a container
#  file:
#    src: '{{ docker_openvpn_target_base_dir }}/{{ item }}/openvpn.conf'
#   dest: '{{ docker_openvpn_target_base_dir }}/{{ item }}.conf'
#    state: 'link'
#  with_flattened:
#    - docker_openvpn_users_list
#    - docker_openvpn_users_group_list
#    - docker_openvpn_users_host_list
#  when: item is defined and item != ""

- name: Start OpenVPN
  command: docker run -v openvpn:/etc/openvpn -d -p 1194:1194/udp --cap-add=NET_ADMIN kylemanna/openvpn
  tags: start_openvpn


#- name: Install OpenVPN docker container
#  docker:
#    name: openvpn
#    image: kylemanna/openvpn:latest
#    state: started
#    pull: always
#    command: -v openvpn:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u udp://vpn.litiushkin.ru
#    volumes:
#    - /openvpn
#    ports:
#    - "1194:1194/udp"
#  tags: pull_image

#- name: Install OpenVPN stop1
#  docker:
#    name: openvpn
#    state: stopped
#    image: kylemanna/openvpn:latest
#  tags: openvpn_stop

#- name: Install OpenVPN step2
#  docker:
#    name: openvpn
#    state: reload
#    image: kylemanna/openvpn:latest
#    command: -v openvpn/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpki
#  tags: image_openvpn_initpki

#- name: Install OpenVPN stop2
#  docker:
#    name: openvpn 
#    state: stopped
#    image: kylemanna/openvpn:latest
#  tags: openvpn_stop

#- name: Install OpenVPN step3
#  docker:
#    name: openvpn
#    state: reload
#    image: kylemanna/openvpn:latest
#    command: -v openvpn:/etc/openvpn -d -p 1194:1194/udp --cap-add=NET_ADMIN kylemanna/openvpn
#  tags: openvpn_image_start
    
